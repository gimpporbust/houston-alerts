<h1>Alerts</h1>

<table id="alerts">
  <%= render "alerts" %>
</table>

<%= content_for :javascripts do %>
<script type="text/javascript">
  $(function() {
    var $alerts = $('#alerts'),
        format = d3.format('02d'),
        parseTimestamp = d3.time.format('%Y-%m-%d %M:%H:%S %Z').parse,
        $countdowns, $countdown, deadline, ts, label, now;
    
    function updateCountdowns() {
      now = new Date();
      $countdowns = $countdowns || $('.countdown');
      $countdowns.each(function() {
        $countdown = $(this);
        deadline = parseTimestamp($countdown.attr('data-deadline'));
        ts = countdown(now, deadline);
        label = [
          ts.hours || 0,
          format(ts.minutes || 0),
          format(ts.seconds || 0)
        ].join(':').replace(/^0+:/);
        if(ts.days) label = '<span class="label">+' + ts.days + '</span> ' + label;
        $countdown.html(label);
      });
    }
    
    function update() {
      $countdowns = null;
      updateCountdowns();
      $('body').toggleClass('green', $('.houston-alert').length == 0);
    }
    
    setInterval(updateCountdowns, 1000);
    
    new Refresher()
      .container('#container')
      .interval(45 * 1000) // 45 seconds
      .callback(function() {
        $.get('/alerts').done(function(html) {
          $alerts.html(html);
          update();
        });
      }).render();
    
    update();
  });
</script>
<% end %>
